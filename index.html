<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deezer API Preview Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    #controls button {
      margin: 5px;
      padding: 10px 20px;
    }
    #progress-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    #progress {
      flex: 1;
      margin: 0 10px;
    }
    .played {
      color: gray;
    }
  </style>
</head>
<body>
  <h2>Deezer Preview Player (via API)</h2>

  <input type="file" id="fileInput" accept=".csv">
  <div id="remainingCount"></div>

  <div id="controls">
    <button onclick="rewind()">Rewind 5s</button>
    <button onclick="playPause()" id="playPauseBtn">Play</button>
    <button onclick="next()">Next</button>
  </div>

  <div id="progress-container">
    <span id="currentTime">0:00</span>
    <input type="range" id="progress" value="0" min="0" max="30">
    <span>0:30</span>
  </div>

  <ul id="songList"></ul>

  <audio id="audio" preload="auto"></audio>

  <script>
    let songs = [];
    let currentIndex = 0;
    const audio = document.getElementById("audio");
    const progress = document.getElementById("progress");
    const currentTimeDisplay = document.getElementById("currentTime");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const songListEl = document.getElementById("songList");
    const remainingCount = document.getElementById("remainingCount");

    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(evt) {
        const lines = evt.target.result.split('\n');
        songs = lines.map(line => {
          const [title, artist] = line.split(',');
          return { title: title?.trim(), artist: artist?.trim(), preview: '', played: false };
        }).filter(song => song.title && song.artist);
        renderSongList();
        updateRemaining();
      };
      reader.readAsText(file);
    });

    function renderSongList() {
      songListEl.innerHTML = '';
      const sorted = [...songs.filter(s => !s.played), ...songs.filter(s => s.played)];
      sorted.forEach((song, index) => {
        const li = document.createElement("li");
        li.textContent = `${song.title} - ${song.artist}`;
        li.className = song.played ? "played" : "";
        songListEl.appendChild(li);
      });
    }

    function updateRemaining() {
      const count = songs.filter(s => !s.played).length;
      remainingCount.textContent = `Songs remaining: ${count}`;
    }

    function playPause() {
      if (audio.paused) {
        if (!audio.src) {
          playSong(currentIndex);
        } else {
          audio.play();
        }
        playPauseBtn.textContent = "Pause";
      } else {
        audio.pause();
        playPauseBtn.textContent = "Play";
      }
    }

    function rewind() {
      audio.currentTime = Math.max(0, audio.currentTime - 5);
    }

    async function next() {
      if (currentIndex < songs.length - 1) {
        songs[currentIndex].played = true;
        currentIndex++;
        await playSong(currentIndex);
      }
      renderSongList();
      updateRemaining();
    }

    async function playSong(index) {
      const song = songs[index];

      if (!song.preview) {
        const query = encodeURIComponent(`${song.title} ${song.artist}`);
        const res = await fetch(`https://api.deezer.com/search?q=${query}&output=jsonp&limit=1`);
        const text = await res.text();
        const json = JSON.parse(text.replace(/^.+?\((.*)\)$/, '$1'));
        song.preview = json.data?.[0]?.preview || '';
      }

      if (song.preview) {
        audio.src = song.preview;
        audio.currentTime = 0;
        audio.play();
        playPauseBtn.textContent = "Pause";
      } else {
        alert(`Preview not found for: ${song.title} - ${song.artist}`);
        next();
      }
    }

    audio.addEventListener("ended", () => {
      songs[currentIndex].played = true;
      currentIndex++;
      if (currentIndex < songs.length) {
        playSong(currentIndex);
      }
      renderSongList();
      updateRemaining();
    });

    audio.addEventListener("timeupdate", () => {
      progress.value = audio.currentTime;
      const mins = Math.floor(audio.currentTime / 60);
      const secs = Math.floor(audio.currentTime % 60).toString().padStart(2, '0');
      currentTimeDisplay.textContent = `${mins}:${secs}`;
    });

    progress.addEventListener("input", () => {
      audio.currentTime = progress.value;
    });
  </script>
</body>
</html>
