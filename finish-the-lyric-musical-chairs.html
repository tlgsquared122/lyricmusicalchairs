<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Finish the Lyric Musical Chairs - Dual Track Player (iPad Fix)</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    #tagline-container img { max-width: 100%; height: auto; display: block; margin: 0 auto 20px; }
    h1 { text-align: center; }
    .tracks { display: flex; gap: 20px; justify-content: space-between; }
    .track-container { flex: 1; }
    .track-info { text-align: center; margin-bottom: 5px; }
    .track-label { font-size: 1.2rem; font-weight: bold; }
    .track-meta { font-size: 1rem; color: #555; }
    progress { width: 100%; height: 10px; background: #ddd; border: none; border-radius: 5px; }
    progress::-webkit-progress-bar { background-color: #ddd; border-radius: 5px; }
    progress::-webkit-progress-value { background-color: #007bff; border-radius: 5px; }
    .time-display { text-align: center; font-size: 0.9rem; margin-top: 3px; }
    .controls, .remaining-container { text-align: center; margin-top: 20px; }
    .controls button, .remaining-container button {
      padding: 15px 30px;
      font-size: 1.2rem;
      margin: 0 10px;
      border-radius: 8px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      -webkit-user-select: none;
      -webkit-appearance: none;
      appearance: none;
    }
    /* Remove hover effect on touch devices */
    @media (hover: none) {
      .controls button:hover, .remaining-container button:hover {
        background: #007bff;
      }
    }
    /* Keep background on active, remove stuck darker state */
    .controls button:active, .remaining-container button:active {
      background: #0056b3 !important;
      opacity: 1 !important;
    }
    .controls button:focus, .remaining-container button:focus { outline: none; }
    /* Smaller reset button */
    #resetBtn {
      padding: 8px 16px;
      font-size: 0.9rem;
      margin: 0 5px;
      -webkit-appearance: none;
      appearance: none;
    }
    #remainingCount { font-size: 1rem; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="tagline-container">
    <img src="https://raw.githubusercontent.com/tlgsquared122/lyricmusicalchairs/main/tagline.png" alt="Your Tagline" onerror="this.style.display='none';">
  </div>
  <h1>Finish the Lyric Musical Chairs</h1>
  <div class="tracks">
    <div class="track-container" id="trackA-container">
      <div class="track-info">
        <div class="track-label" id="trackA-label">Track A</div>
        <div class="track-meta" id="trackA-info">Loading...</div>
      </div>
      <progress id="progressA" value="0" max="1"></progress>
      <div class="time-display" id="timeA">0:00 / 0:00</div>
      <audio id="audioA" playsinline webkit-playsinline preload="auto"></audio>
    </div>
    <div class="track-container" id="trackB-container">
      <div class="track-info">
        <div class="track-label" id="trackB-label">Track B</div>
        <div class="track-meta" id="trackB-info">Loading...</div>
      </div>
      <progress id="progressB" value="0" max="1"></progress>
      <div class="time-display" id="timeB">0:00 / 0:00</div>
      <audio id="audioB" playsinline webkit-playsinline preload="auto"></audio>
    </div>
  </div>
  <div class="controls">
    <button id="rewindBtn">Rewind 5s</button>
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>
    <button id="nextBtn">Next</button>
  </div>
  <div class="remaining-container">
    <div id="remainingCount">Remaining songs: 0</div>
    <button id="resetBtn">Reset Songs</button>
  </div>
  <script>
    // Unlock Web Audio API on first interaction
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    function unlockAudio() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      document.removeEventListener('touchend', unlockAudio);
      document.removeEventListener('click', unlockAudio);
    }
    document.addEventListener('touchend', unlockAudio, false);
    document.addEventListener('click', unlockAudio, false);

    var csvUrl = 'https://raw.githubusercontent.com/tlgsquared122/lyricmusicalchairs/main/top_songs_randomized.csv';
    var songs = [], usedIndexes = new Set(), lastIndex = null;
    var audioA, audioB, metaA, metaB, progressA, progressB, timeA, timeB;
    var rewindBtn, playBtn, pauseBtn, nextBtn, resetBtn, remainingEl;
    var lastPlayed = null, rewindTimeout, FADE_DURATION = 2;

    function formatTime(sec) {
      var m = Math.floor(sec/60), s = Math.floor(sec%60).toString().padStart(2,'0');
      return m + ':' + s;
    }

    function updateTimeDisplay(audio, progress, timeEl) {
      if (audio.duration) {
        progress.max = audio.duration;
        progress.value = audio.currentTime;
        timeEl.textContent = formatTime(audio.currentTime) + ' / ' + formatTime(audio.duration);
        if (audio.duration - audio.currentTime <= FADE_DURATION && !audio._fadingOut) fadeOut(audio);
      }
    }

    function updateRemaining() {
      remainingEl.textContent = 'Remaining songs: ' + (songs.length - usedIndexes.size);
    }

    function getRandomSong() {
      if (usedIndexes.size >= songs.length) { usedIndexes.clear(); lastIndex = null; }
      var valid = [];
      for (var i = 0; i < songs.length; i++) {
        if (!usedIndexes.has(i) && (lastIndex === null || Math.abs(i - lastIndex) > 6)) valid.push(i);
      }
      var pool = valid.length ? valid : Array.from({length: songs.length}, (_, i) => i).filter(function(i) { return !usedIndexes.has(i); });
      var idx = pool[Math.floor(Math.random() * pool.length)];
      usedIndexes.add(idx);
      lastIndex = idx;
      updateRemaining();
      return songs[idx];
    }

    function getPreviewOrNext() {
      return new Promise(function(resolve, reject) {
        var song = getRandomSong();
        if (!song) return reject('No songs available');
        var q = 'track:"' + song.title + '" artist:"' + song.artist + '"';
        var cb = 'dzCb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        var script = document.createElement('script');
        window[cb] = function(data) {
          document.body.removeChild(script);
          delete window[cb];
          if (data.data && data.data.length) resolve({ song: song, preview: data.data[0].preview });
          else getPreviewOrNext().then(resolve).catch(reject);
        };
        script.src = 'https://api.deezer.com/search?q=' + encodeURIComponent(q) + '&output=jsonp&callback=' + cb;
        script.onerror = function() {
          document.body.removeChild(script);
          delete window[cb];
          getPreviewOrNext().then(resolve).catch(reject);
        };
        document.body.appendChild(script);
      });
    }

    function fadeIn(audio) {
      audio._fadingOut = false;
      audio.volume = 0;
      var step = 1 / (FADE_DURATION * 50);
      var interval = setInterval(function() {
        if (audio.volume < 1 && !audio._fadingOut) {
          audio.volume = Math.min(audio.volume + step, 1);
        } else {
          audio.volume = 1;
          clearInterval(interval);
        }
      }, 20);
    }

    function fadeOut(audio) {
      audio._fadingOut = true;
      var step = 1 / (FADE_DURATION * 50);
      var interval = setInterval(function() {
        if (audio.volume > 0) {
          audio.volume = Math.max(audio.volume - step, 0);
        } else {
          audio.volume = 0;
          clearInterval(interval);
        }
      }, 20);
    }

    function setupEvents() {
      [audioA, audioB].forEach(function(a) {
        a.addEventListener('timeupdate', function() {
          var p = a === audioA ? progressA : progressB;
          var t = a === audioA ? timeA : timeB;
          updateTimeDisplay(a, p, t);
          if (a.currentTime >= 28) {
            var o = a === audioA ? audioB : audioA;
            if (o.paused) o.play();
          }
        });
        a.addEventListener('play', function() {
          lastPlayed = a;
          if (a.currentTime === 0) fadeIn(a);
          else a.volume = 1;
        });
      });
      audioA.addEventListener('ended', function() { loadNext('A'); });
      audioB.addEventListener('ended', function() { loadNext('B'); });
    }

    document.addEventListener('DOMContentLoaded', function() {
      audioA = document.getElementById('audioA');
      audioB = document.getElementById('audioB');
      metaA = document.getElementById('trackA-info');
      metaB = document.getElementById('trackB-info');
      progressA = document.getElementById('progressA');
      progressB = document.getElementById('progressB');
      timeA = document.getElementById('timeA');
      timeB = document.getElementById('timeB');
      rewindBtn = document.getElementById('rewindBtn');
      playBtn = document.getElementById('playBtn');
      pauseBtn = document.getElementById('pauseBtn');
      nextBtn = document.getElementById('nextBtn');
      resetBtn = document.getElementById('resetBtn');
      remainingEl = document.getElementById('remainingCount');

      ['touchstart','touchend','click'].forEach(function(evt) {
        rewindBtn.addEventListener(evt, function() { this.blur(); var tr = lastPlayed || audioA; clearTimeout(rewindTimeout); tr.currentTime = Math.max(0, tr.currentTime - 5); tr.play(); rewindTimeout = setTimeout(function() { tr.pause(); }, 5000); });
        playBtn.addEventListener(evt, function() { this.blur(); (lastPlayed || audioA).play(); });
        pauseBtn.addEventListener(evt, function() { this.blur(); audioA.pause(); audioB.pause(); clearTimeout(rewindTimeout); });
        nextBtn.addEventListener(evt, function() { this.blur(); var c = lastPlayed || audioA; var o = c === audioA ? audioB : audioA; var id = c === audioA ? 'A' : 'B'; loadNext(id).then(function() { c.pause(); o.play(); lastPlayed = o; }); });
        resetBtn.addEventListener(evt, function() { this.blur(); usedIndexes.clear(); lastIndex = null; updateRemaining(); });
      });

      Papa.parse(csvUrl, { download: true, skipEmptyLines: true, header: false, complete: function(res) {
          songs = res.data.map(function(r) { return { title: r[0].trim(), artist: r[1].trim() }; }).filter(function(s) { return s.title && s.artist; });
          updateRemaining(); initPlayer();
        }
      });
    });

    function initPlayer() {
      Promise.all([getPreviewOrNext(), getPreviewOrNext()]).then(function(results) {
        var a = results[0], b = results[1];
        metaA.textContent = a.song.title + ' - ' + a.song.artist;
        audioA.src = a.preview; audioA.play();
        metaB.textContent = b.song.title + ' - ' + b.song.artist;
        audioB.src = b.preview; setupEvents();
      }).catch(function(err) { console.error('Initialization error:', err); });
    }

    function loadNext(track) {
      var audio = track === 'A' ? audioA : audioB;
      var meta  = track === 'A' ? metaA : metaB;
      var prog  = track === 'A' ? progressA : progressB;
      var tm    = track === 'A' ? timeA : timeB;
      return getPreviewOrNext().then(function(res) {
        meta.textContent = res.song.title + ' - ' + res.song.artist;
        audio.src = res.preview; prog.value = 0; tm.textContent = '0:00 / 0:00'; audio.volume = 0;
      }).catch(function(err) { console.error('Load next error:', err); });
    }
  </script>
</body>
</html>
