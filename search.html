<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Finish the Lyric Musical Chairs</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; padding: 0 20px; }
    h1 { text-align: center; font-size: 1.8rem; margin-bottom: 20px; }
    #search-container { display: flex; gap: 10px; margin-bottom: 20px; }
    #searchBar { flex: 1; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    #searchBtn { padding: 10px 20px; font-size: 1rem; border: none; border-radius: 4px; background-color: #007BFF; color: white; cursor: pointer; }
    #searchBtn:disabled { background-color: #ccc; cursor: default; }
    .song { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    .song-title { font-size: 1rem; }
    .add-btn { padding: 6px 12px; font-size: 0.9rem; border: none; border-radius: 4px; background-color: #28a745; color: white; cursor: pointer; }
    .add-btn:disabled { background-color: #ccc; cursor: default; }
  </style>
</head>
<body>
  <h1>Finish the Lyric Musical Chairs</h1>
  <div id="search-container">
    <input id="searchBar" type="text" placeholder="Search song or artist...">
    <button id="searchBtn">Search</button>
  </div>
  <div id="results"></div>

  <script>
    // GitHub configuration
    const GITHUB_OWNER  = 'tlgsquared122';
    const GITHUB_REPO   = 'lyricmusicalchairs'; // Actual repo name (ensure this matches exactly)
    const REPO_ENCODED  = encodeURIComponent(GITHUB_REPO);
    const FILE_PATH     = 'songs_list.csv';
    const BRANCH        = 'main';
    const GITHUB_TOKEN  = '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';

    const BASE_API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${REPO_ENCODED}/contents/${FILE_PATH}`;

    const searchBtn = document.getElementById('searchBtn');
    const searchBar = document.getElementById('searchBar');
    const resultsDiv = document.getElementById('results');

    searchBtn.addEventListener('click', () => {
      const query = searchBar.value.trim();
      if (!query) return;
      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';
      const script = document.createElement('script');
      script.src = `https://api.deezer.com/search?q=${encodeURIComponent(query)}&limit=10&output=jsonp&callback=showResults`;
      document.body.appendChild(script);
    });

    function showResults(response) {
      searchBtn.disabled = false;
      searchBtn.textContent = 'Search';
      resultsDiv.innerHTML = '';
      if (!response.data || response.data.length === 0) {
        resultsDiv.textContent = 'No results found.';
        return;
      }
      response.data.forEach(track => {
        const div = document.createElement('div');
        div.className = 'song';

        const titleSpan = document.createElement('span');
        titleSpan.className = 'song-title';
        titleSpan.textContent = `${track.title} — ${track.artist.name}`;

        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = 'Add to CSV';
        addBtn.addEventListener('click', () => addToCSV(track, addBtn));

        div.appendChild(titleSpan);
        div.appendChild(addBtn);
        resultsDiv.appendChild(div);
      });
    }

    async function addToCSV(track, button) {
      button.disabled = true;
      button.textContent = 'Updating...';
      try {
        const url = `${BASE_API_URL}?ref=${BRANCH}`;
        // Fetch raw CSV content
        const rawRes = await fetch(url, {
          headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            Accept: 'application/vnd.github.v3.raw'
          }
        });
        if (!rawRes.ok) {
          console.error('Raw fetch failed', rawRes.status, rawRes.statusText);
          throw new Error('Failed to fetch CSV content');
        }
        const csvText = await rawRes.text();

        // Fetch metadata for SHA
        const metaRes = await fetch(url, {
          headers: { Authorization: `token ${GITHUB_TOKEN}` }
        });
        if (!metaRes.ok) {
          console.error('Meta fetch failed', metaRes.status, metaRes.statusText);
          throw new Error('Failed to fetch file metadata');
        }
        const meta = await metaRes.json();

        // Append new row
        const { title, artist } = track;
        const newLine = `\n"${title.replace(/"/g, '\\"')}","${artist.name.replace(/"/g, '\\"')}"`;
        const updatedCsv = csvText.trim() + newLine;

        // Commit update
        const contentBase64 = btoa(unescape(encodeURIComponent(updatedCsv)));
        const commitRes = await fetch(url, {
          method: 'PUT',
          headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Add ${title} by ${artist.name}`,
            content: contentBase64,
            sha: meta.sha,
            branch: BRANCH
          })
        });
        if (!commitRes.ok) {
          console.error('Commit failed', commitRes.status, commitRes.statusText);
          throw new Error('Commit failed');
        }

        button.textContent = 'Added ✓';
      } catch (err) {
        console.error(err);
        button.disabled = false;
        button.textContent = 'Error';
        alert('Error updating CSV: ' + err.message);
      }
    }
  </script>

  <!-- Troubleshooting Tips -->

  <section style="margin-top:20px;">
    <h2>Troubleshooting</h2>
    <ul>
      <li><strong>CORS issues:</strong> GitHub API may block requests from GitHub Pages due to CORS. Ensure your host allows cross-origin requests or use a CORS proxy.</li>
      <li><strong>Incorrect repo/path:</strong> Verify `GITHUB_OWNER`, `GITHUB_REPO`, `FILE_PATH`, and `BRANCH` exactly match your GitHub settings (case-sensitive).</li>
      <li><strong>Invalid token:</strong> Confirm your PAT has <code>repo</code> or <code>public_repo</code> scope and that it has not expired.</li>
      <li><strong>Rate limiting:</strong> GitHub’s unauthenticated rate limit is low. Even with a token, excessive requests may be blocked.</li>
      <li><strong>Network errors:</strong> Check your browser console for network errors (DNS, HTTPS) and ensure you have internet connectivity.</li>
    </ul>
  </section>
</body>
</body>
</html>
